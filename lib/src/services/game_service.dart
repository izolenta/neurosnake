import 'dart:math';

import 'package:neurosnake/src/models/direction.dart';
import 'package:neurosnake/src/models/input_condition.dart';
import 'package:neurosnake/src/utils/calc_helper.dart';
import 'package:perceptron/perceptron.dart';

class GameService {

  static const jsonData = '{"netConfiguration":[8,20,4],"activationFunction":"sigmoid","synapses":[{"layer":0,"origin":0,"destination":0,"weight":0.3086296342938065},{"layer":0,"origin":0,"destination":1,"weight":-1.794593651018217},{"layer":0,"origin":0,"destination":2,"weight":-2.9030227892476503},{"layer":0,"origin":0,"destination":3,"weight":-5.353018877655617},{"layer":0,"origin":0,"destination":4,"weight":-1.2738561942422968},{"layer":0,"origin":0,"destination":5,"weight":-0.3092897131177749},{"layer":0,"origin":0,"destination":6,"weight":-5.727826768004847},{"layer":0,"origin":0,"destination":7,"weight":4.345023441959702},{"layer":0,"origin":0,"destination":8,"weight":3.3055448980058664},{"layer":0,"origin":0,"destination":9,"weight":1.427063026587099},{"layer":0,"origin":0,"destination":10,"weight":-0.7440277478933861},{"layer":0,"origin":0,"destination":11,"weight":-0.8878657860493319},{"layer":0,"origin":0,"destination":12,"weight":-0.019767301868693465},{"layer":0,"origin":0,"destination":13,"weight":1.9750617265311692},{"layer":0,"origin":0,"destination":14,"weight":-1.851904390505215},{"layer":0,"origin":0,"destination":15,"weight":3.760058757110194},{"layer":0,"origin":0,"destination":16,"weight":-6.8903311316740705},{"layer":0,"origin":0,"destination":17,"weight":-0.44124265465225854},{"layer":0,"origin":0,"destination":18,"weight":3.123128682981099},{"layer":0,"origin":0,"destination":19,"weight":0.7115849690719526},{"layer":0,"origin":1,"destination":0,"weight":0.6675301140694003},{"layer":0,"origin":1,"destination":1,"weight":0.3822459167348465},{"layer":0,"origin":1,"destination":2,"weight":1.25756547585222},{"layer":0,"origin":1,"destination":3,"weight":0.6333561222209643},{"layer":0,"origin":1,"destination":4,"weight":0.4633705217408144},{"layer":0,"origin":1,"destination":5,"weight":-6.354709522994079},{"layer":0,"origin":1,"destination":6,"weight":-0.07366981388224055},{"layer":0,"origin":1,"destination":7,"weight":-2.353727700780191},{"layer":0,"origin":1,"destination":8,"weight":-5.692112779865901},{"layer":0,"origin":1,"destination":9,"weight":-0.5192984073251878},{"layer":0,"origin":1,"destination":10,"weight":-4.027314456628546},{"layer":0,"origin":1,"destination":11,"weight":6.016436462934809},{"layer":0,"origin":1,"destination":12,"weight":-0.28318169646774366},{"layer":0,"origin":1,"destination":13,"weight":2.7094158748229837},{"layer":0,"origin":1,"destination":14,"weight":-0.1572423251143301},{"layer":0,"origin":1,"destination":15,"weight":-3.001728335722327},{"layer":0,"origin":1,"destination":16,"weight":1.540951967631419},{"layer":0,"origin":1,"destination":17,"weight":1.6659808190225918},{"layer":0,"origin":1,"destination":18,"weight":1.7600846263525045},{"layer":0,"origin":1,"destination":19,"weight":2.28651537132216},{"layer":0,"origin":2,"destination":0,"weight":-4.261909746970635},{"layer":0,"origin":2,"destination":1,"weight":3.5573915187746454},{"layer":0,"origin":2,"destination":2,"weight":-3.814173292000908},{"layer":0,"origin":2,"destination":3,"weight":1.477428875688534},{"layer":0,"origin":2,"destination":4,"weight":6.604240137905392},{"layer":0,"origin":2,"destination":5,"weight":0.9686810936720066},{"layer":0,"origin":2,"destination":6,"weight":2.8673567638936404},{"layer":0,"origin":2,"destination":7,"weight":-2.922425851869484},{"layer":0,"origin":2,"destination":8,"weight":0.7628260653703522},{"layer":0,"origin":2,"destination":9,"weight":-1.0604963178526292},{"layer":0,"origin":2,"destination":10,"weight":-0.3332477852002744},{"layer":0,"origin":2,"destination":11,"weight":-0.717433816027856},{"layer":0,"origin":2,"destination":12,"weight":-0.469475728340426},{"layer":0,"origin":2,"destination":13,"weight":-5.538988213022477},{"layer":0,"origin":2,"destination":14,"weight":0.8562674036175476},{"layer":0,"origin":2,"destination":15,"weight":2.7950570830873147},{"layer":0,"origin":2,"destination":16,"weight":0.32603808261850054},{"layer":0,"origin":2,"destination":17,"weight":2.6767632242574595},{"layer":0,"origin":2,"destination":18,"weight":-0.5353956223273529},{"layer":0,"origin":2,"destination":19,"weight":-0.21670578005440147},{"layer":0,"origin":3,"destination":0,"weight":0.35612256875043424},{"layer":0,"origin":3,"destination":1,"weight":-0.5439248647479019},{"layer":0,"origin":3,"destination":2,"weight":2.8773231529143564},{"layer":0,"origin":3,"destination":3,"weight":1.1799178653844307},{"layer":0,"origin":3,"destination":4,"weight":-0.5761624118687623},{"layer":0,"origin":3,"destination":5,"weight":4.118428982666451},{"layer":0,"origin":3,"destination":6,"weight":1.8746301528048528},{"layer":0,"origin":3,"destination":7,"weight":3.078622688972247},{"layer":0,"origin":3,"destination":8,"weight":0.7981514929331324},{"layer":0,"origin":3,"destination":9,"weight":1.28895119802182},{"layer":0,"origin":3,"destination":10,"weight":-0.3432424419015647},{"layer":0,"origin":3,"destination":11,"weight":-1.5713703212827859},{"layer":0,"origin":3,"destination":12,"weight":0.73875309130901},{"layer":0,"origin":3,"destination":13,"weight":0.5288465624740775},{"layer":0,"origin":3,"destination":14,"weight":-0.10681433988472408},{"layer":0,"origin":3,"destination":15,"weight":-1.9686460896948343},{"layer":0,"origin":3,"destination":16,"weight":0.1980520028653742},{"layer":0,"origin":3,"destination":17,"weight":-4.81002112475627},{"layer":0,"origin":3,"destination":18,"weight":-5.098985637877985},{"layer":0,"origin":3,"destination":19,"weight":-0.7863122337479355},{"layer":0,"origin":4,"destination":0,"weight":-2.1620785138333245},{"layer":0,"origin":4,"destination":1,"weight":-0.2467365166521338},{"layer":0,"origin":4,"destination":2,"weight":1.2118357540786504},{"layer":0,"origin":4,"destination":3,"weight":2.939823279671471},{"layer":0,"origin":4,"destination":4,"weight":0.05376043581676408},{"layer":0,"origin":4,"destination":5,"weight":0.038024007868845064},{"layer":0,"origin":4,"destination":6,"weight":1.3281387635565016},{"layer":0,"origin":4,"destination":7,"weight":-0.3430009621139192},{"layer":0,"origin":4,"destination":8,"weight":-1.6090603948336155},{"layer":0,"origin":4,"destination":9,"weight":-0.8281806837501067},{"layer":0,"origin":4,"destination":10,"weight":-3.9784458915081773},{"layer":0,"origin":4,"destination":11,"weight":-0.45492690593849017},{"layer":0,"origin":4,"destination":12,"weight":0.27939020222952266},{"layer":0,"origin":4,"destination":13,"weight":-0.6441539998295852},{"layer":0,"origin":4,"destination":14,"weight":1.4842791630970376},{"layer":0,"origin":4,"destination":15,"weight":-1.0932294420878637},{"layer":0,"origin":4,"destination":16,"weight":3.9373932115816683},{"layer":0,"origin":4,"destination":17,"weight":0.06290448188102066},{"layer":0,"origin":4,"destination":18,"weight":-2.631021635333197},{"layer":0,"origin":4,"destination":19,"weight":-1.1368029233692218},{"layer":0,"origin":5,"destination":0,"weight":-3.767803742326903},{"layer":0,"origin":5,"destination":1,"weight":0.303238371505862},{"layer":0,"origin":5,"destination":2,"weight":0.544725760378346},{"layer":0,"origin":5,"destination":3,"weight":-1.0442717060466757},{"layer":0,"origin":5,"destination":4,"weight":-0.7567212007207288},{"layer":0,"origin":5,"destination":5,"weight":0.9999613013655848},{"layer":0,"origin":5,"destination":6,"weight":-0.1492349931849618},{"layer":0,"origin":5,"destination":7,"weight":1.5785625432508126},{"layer":0,"origin":5,"destination":8,"weight":2.498441960895027},{"layer":0,"origin":5,"destination":9,"weight":0.4406038064306138},{"layer":0,"origin":5,"destination":10,"weight":4.570548554911099},{"layer":0,"origin":5,"destination":11,"weight":-2.115844132303907},{"layer":0,"origin":5,"destination":12,"weight":-0.6478053751251541},{"layer":0,"origin":5,"destination":13,"weight":-1.6838928789366152},{"layer":0,"origin":5,"destination":14,"weight":-0.7745148852921376},{"layer":0,"origin":5,"destination":15,"weight":1.506788348100254},{"layer":0,"origin":5,"destination":16,"weight":-0.7523743889141637},{"layer":0,"origin":5,"destination":17,"weight":-1.4449594276107418},{"layer":0,"origin":5,"destination":18,"weight":-1.2287891754777331},{"layer":0,"origin":5,"destination":19,"weight":-0.4515329895164326},{"layer":0,"origin":6,"destination":0,"weight":4.412772199278103},{"layer":0,"origin":6,"destination":1,"weight":-1.767144667877104},{"layer":0,"origin":6,"destination":2,"weight":2.294013317612179},{"layer":0,"origin":6,"destination":3,"weight":-0.7384211694653325},{"layer":0,"origin":6,"destination":4,"weight":-3.2556798475175084},{"layer":0,"origin":6,"destination":5,"weight":-0.17638098631785654},{"layer":0,"origin":6,"destination":6,"weight":-2.5900879245573902},{"layer":0,"origin":6,"destination":7,"weight":2.130188549740711},{"layer":0,"origin":6,"destination":8,"weight":-0.9744410135522045},{"layer":0,"origin":6,"destination":9,"weight":0.6582729307135431},{"layer":0,"origin":6,"destination":10,"weight":0.34922137673690995},{"layer":0,"origin":6,"destination":11,"weight":0.9185071407773892},{"layer":0,"origin":6,"destination":12,"weight":0.10050406403028926},{"layer":0,"origin":6,"destination":13,"weight":2.443175912743589},{"layer":0,"origin":6,"destination":14,"weight":-0.22356634187191923},{"layer":0,"origin":6,"destination":15,"weight":-2.2247539187668903},{"layer":0,"origin":6,"destination":16,"weight":-1.6377832924406204},{"layer":0,"origin":6,"destination":17,"weight":-3.038589114819571},{"layer":0,"origin":6,"destination":18,"weight":0.707178150314554},{"layer":0,"origin":6,"destination":19,"weight":0.37207086160425007},{"layer":0,"origin":7,"destination":0,"weight":-0.26361534842139706},{"layer":0,"origin":7,"destination":1,"weight":0.6334715421957328},{"layer":0,"origin":7,"destination":2,"weight":-1.7297925087271697},{"layer":0,"origin":7,"destination":3,"weight":-1.4809051691061643},{"layer":0,"origin":7,"destination":4,"weight":1.7379589645788232},{"layer":0,"origin":7,"destination":5,"weight":-3.450147309166946},{"layer":0,"origin":7,"destination":6,"weight":-1.4848748072873912},{"layer":0,"origin":7,"destination":7,"weight":-2.4223697341415913},{"layer":0,"origin":7,"destination":8,"weight":-1.5090770671373908},{"layer":0,"origin":7,"destination":9,"weight":-0.8630779443716091},{"layer":0,"origin":7,"destination":10,"weight":-2.9373811545740827},{"layer":0,"origin":7,"destination":11,"weight":2.0068871274545876},{"layer":0,"origin":7,"destination":12,"weight":-0.5489416848900958},{"layer":0,"origin":7,"destination":13,"weight":-1.6978212996752104},{"layer":0,"origin":7,"destination":14,"weight":-0.7171011131696389},{"layer":0,"origin":7,"destination":15,"weight":1.289152600074084},{"layer":0,"origin":7,"destination":16,"weight":-2.396372476842991},{"layer":0,"origin":7,"destination":17,"weight":3.173665160134984},{"layer":0,"origin":7,"destination":18,"weight":3.520293496966388},{"layer":0,"origin":7,"destination":19,"weight":0.4884138462556821},{"layer":0,"origin":8,"destination":0,"weight":-2.3953980323377015},{"layer":0,"origin":8,"destination":1,"weight":0.41210688010775226},{"layer":0,"origin":8,"destination":2,"weight":1.219646031079711},{"layer":0,"origin":8,"destination":3,"weight":-0.8185296613540373},{"layer":0,"origin":8,"destination":4,"weight":0.10995974997703283},{"layer":0,"origin":8,"destination":5,"weight":1.474530990988515},{"layer":0,"origin":8,"destination":6,"weight":0.3177506294816929},{"layer":0,"origin":8,"destination":7,"weight":-1.3009351054485725},{"layer":0,"origin":8,"destination":8,"weight":-1.4907022850461749},{"layer":0,"origin":8,"destination":9,"weight":-0.6879961672362169},{"layer":0,"origin":8,"destination":10,"weight":-2.082223406707142},{"layer":0,"origin":8,"destination":11,"weight":0.1544442962189961},{"layer":0,"origin":8,"destination":12,"weight":0.5272090127021575},{"layer":0,"origin":8,"destination":13,"weight":-2.2470860459669524},{"layer":0,"origin":8,"destination":14,"weight":-0.39264385481562014},{"layer":0,"origin":8,"destination":15,"weight":-0.9472123173403726},{"layer":0,"origin":8,"destination":16,"weight":-0.4979447805319359},{"layer":0,"origin":8,"destination":17,"weight":-2.0314019896531392},{"layer":0,"origin":8,"destination":18,"weight":-2.615768219801449},{"layer":0,"origin":8,"destination":19,"weight":-0.539065238499069},{"layer":1,"origin":0,"destination":0,"weight":-3.575823157055977},{"layer":1,"origin":0,"destination":1,"weight":-4.740439655847247},{"layer":1,"origin":0,"destination":2,"weight":4.492437713532429},{"layer":1,"origin":0,"destination":3,"weight":-4.7881650185834115},{"layer":1,"origin":1,"destination":0,"weight":0.9507904666004321},{"layer":1,"origin":1,"destination":1,"weight":-0.6283495592855808},{"layer":1,"origin":1,"destination":2,"weight":-3.7164716615197495},{"layer":1,"origin":1,"destination":3,"weight":0.8479569581948664},{"layer":1,"origin":2,"destination":0,"weight":3.1084632875569405},{"layer":1,"origin":2,"destination":1,"weight":-1.969356552493158},{"layer":1,"origin":2,"destination":2,"weight":2.8493051213951253},{"layer":1,"origin":2,"destination":3,"weight":-5.198333094716532},{"layer":1,"origin":3,"destination":0,"weight":3.1234155982739624},{"layer":1,"origin":3,"destination":1,"weight":-3.718075190242844},{"layer":1,"origin":3,"destination":2,"weight":-1.600787490670228},{"layer":1,"origin":3,"destination":3,"weight":-5.260135195981625},{"layer":1,"origin":4,"destination":0,"weight":1.480680560591927},{"layer":1,"origin":4,"destination":1,"weight":0.40923123733112504},{"layer":1,"origin":4,"destination":2,"weight":-6.0873645932045015},{"layer":1,"origin":4,"destination":3,"weight":3.745099629377669},{"layer":1,"origin":5,"destination":0,"weight":1.437226812594028},{"layer":1,"origin":5,"destination":1,"weight":4.5082019319779025},{"layer":1,"origin":5,"destination":2,"weight":-5.016060858548326},{"layer":1,"origin":5,"destination":3,"weight":-5.837620984759857},{"layer":1,"origin":6,"destination":0,"weight":3.6119033567413594},{"layer":1,"origin":6,"destination":1,"weight":-3.481208221308968},{"layer":1,"origin":6,"destination":2,"weight":-3.8603516672819334},{"layer":1,"origin":6,"destination":3,"weight":-4.3283602626313025},{"layer":1,"origin":7,"destination":0,"weight":-6.089670511816647},{"layer":1,"origin":7,"destination":1,"weight":3.24103209831049},{"layer":1,"origin":7,"destination":2,"weight":3.228882801319161},{"layer":1,"origin":7,"destination":3,"weight":-2.300293917761097},{"layer":1,"origin":8,"destination":0,"weight":-5.508372735715456},{"layer":1,"origin":8,"destination":1,"weight":2.67169593914785},{"layer":1,"origin":8,"destination":2,"weight":-3.933981644431581},{"layer":1,"origin":8,"destination":3,"weight":-2.8034223477169915},{"layer":1,"origin":9,"destination":0,"weight":-2.1289831464591376},{"layer":1,"origin":9,"destination":1,"weight":-0.10957272957259948},{"layer":1,"origin":9,"destination":2,"weight":0.2782739242217101},{"layer":1,"origin":9,"destination":3,"weight":-1.424380590656447},{"layer":1,"origin":10,"destination":0,"weight":-4.404339826442595},{"layer":1,"origin":10,"destination":1,"weight":5.377101842971269},{"layer":1,"origin":10,"destination":2,"weight":-5.593161507282101},{"layer":1,"origin":10,"destination":3,"weight":-1.8019694160678703},{"layer":1,"origin":11,"destination":0,"weight":0.31344105837790737},{"layer":1,"origin":11,"destination":1,"weight":-5.0032648461018665},{"layer":1,"origin":11,"destination":2,"weight":3.7985711981406434},{"layer":1,"origin":11,"destination":3,"weight":2.2736631878411573},{"layer":1,"origin":12,"destination":0,"weight":-0.017212703668815856},{"layer":1,"origin":12,"destination":1,"weight":-0.7481802724749304},{"layer":1,"origin":12,"destination":2,"weight":-0.02127860595161544},{"layer":1,"origin":12,"destination":3,"weight":-1.8700368818664603},{"layer":1,"origin":13,"destination":0,"weight":-3.3332014841566626},{"layer":1,"origin":13,"destination":1,"weight":-4.651168848456309},{"layer":1,"origin":13,"destination":2,"weight":3.692247666950059},{"layer":1,"origin":13,"destination":3,"weight":-4.470753521127485},{"layer":1,"origin":14,"destination":0,"weight":1.4223491835977402},{"layer":1,"origin":14,"destination":1,"weight":-0.8969660058247416},{"layer":1,"origin":14,"destination":2,"weight":-0.8264217099945281},{"layer":1,"origin":14,"destination":3,"weight":-1.7057438330731256},{"layer":1,"origin":15,"destination":0,"weight":-3.9951934536166367},{"layer":1,"origin":15,"destination":1,"weight":3.414963090397139},{"layer":1,"origin":15,"destination":2,"weight":-2.8535741757356554},{"layer":1,"origin":15,"destination":3,"weight":1.8158511860686926},{"layer":1,"origin":16,"destination":0,"weight":5.424223510871573},{"layer":1,"origin":16,"destination":1,"weight":-5.949656784559256},{"layer":1,"origin":16,"destination":2,"weight":-3.256279226017402},{"layer":1,"origin":16,"destination":3,"weight":-5.731471392702735},{"layer":1,"origin":17,"destination":0,"weight":-3.5172445268132435},{"layer":1,"origin":17,"destination":1,"weight":-3.534282298131442},{"layer":1,"origin":17,"destination":2,"weight":-4.24348236760106},{"layer":1,"origin":17,"destination":3,"weight":3.8714939277818643},{"layer":1,"origin":18,"destination":0,"weight":-5.947991515664778},{"layer":1,"origin":18,"destination":1,"weight":-4.112199755956244},{"layer":1,"origin":18,"destination":2,"weight":-0.3782443714585372},{"layer":1,"origin":18,"destination":3,"weight":3.9127002771081028},{"layer":1,"origin":19,"destination":0,"weight":-1.4406375348966478},{"layer":1,"origin":19,"destination":1,"weight":-2.803805157565731},{"layer":1,"origin":19,"destination":2,"weight":-0.2104681818188783},{"layer":1,"origin":19,"destination":3,"weight":0.7200365965572356},{"layer":1,"origin":20,"destination":0,"weight":-0.9441531879642275},{"layer":1,"origin":20,"destination":1,"weight":-0.45997462217428087},{"layer":1,"origin":20,"destination":2,"weight":-0.3889616255182208},{"layer":1,"origin":20,"destination":3,"weight":-1.5901757651714423}]}';
  final perceptron = Perceptron.fromJson(jsonData, 10);

  Direction getDirection(InputCondition input) {
    final result = perceptron.process(convertInputConditionToArray(input));
    final maxValue = result.reduce(max);
    if (maxValue == result[0]) {
      return Direction.up;
    }
    if (maxValue == result[1]) {
      return Direction.right;
    }
    if (maxValue == result[2]) {
      return Direction.down;
    }
    return Direction.left;
  }

  void trainNetwork(List<InputCondition> inputs, List<Direction> outputs) {
    final data = <TrainingData>[];
    for (var i = 0; i< inputs.length; i++) {
      final inputArray = convertInputConditionToArray(inputs[i]);
      final outputArray = convertDirectionToOutputArray(outputs[i]);
      data.add(TrainingData(inputArray, outputArray));
    }
    print('Got ${data.length} records for training');
    perceptron.train(data);
    print('network trained');
    print(perceptron.toJson());
  }
}